# redis主从复制

现在有 2 台 Redis 服务器，地址分别是 127.0.0.1:6379 和 127.0.0.1:12345 在 127.0.0.1:12345 的客户端输入命令： 127.0.0.1:12345> SLAVEOF 127.0.0.6379 此时 127.0.0.1:12345 就会去复制 127.0.0.1:6379 的数据。即前者是从服务器，后者为主服务器。

### 步骤

主从同步有同步和命令传播 2 个步骤。 当完成了同步之后，主从服务器就会进入命令传播阶段

1. 同步 从服务器对主服务的同步操作，需要通过 sync 命令来实现，以下是 sync 命令的执行步骤：
   1. 从服务器向主服务器发送 sync 命令
   2. 收到 sync 命令后，主服务器执行 bgsave 命令，用来生成 rdb 文件，并在一个缓冲区中记录从现在开始执行的写命令。
   3. bgsave 执行完成后，将生成的 rdb 文件发送给从服务器，用来给从服务器更新数据主服务器再将缓冲区记录的写命令发送给从服务器，从服务器执行完这些写命令后，此时的数据库状态便和主服务器一致了。
2. 命令传播 在完成同步之后，也许主服务器马上就接受到了新的写命令，执行完该命令后，主从的数据库状态又不一致。为了再次让主从数据库状态一致，主服务器就需要向从服务器执行命令传播操作 ，即把刚才造成不一致的写命令，发送给从服务器去执行。从服务器执行完成之后，主从数据库状态就又恢复一致了。

之所以需要命令传播是因为syn命令是非常昂贵的，生成rdb文件浪费硬件资源，发送rdb文件浪费网络资源。

### 同步的优化

主从同步分为两种情况：

1. 初次复制：从服务器第一次复制当前主服务器 按照同步、命令传播两个阶段执行就行
2. 断线重连后复制：处于命令传播阶段的主从服务器，因为网络问题而中断复制，从服务器通过自动重连，重新连接上主服务器并继续复制。 在断线后重复制的情况下，在 2.8 版本之前，会再次执行同步（sync 命令）和命令传播。如果说，在断线期间，主服务器（已有上万键值对）只执行了几个写命令，为了让从服务器弥补这几个命令，却要重新执行 sync 来生成新的 rdb 文件，这也是非常低效的。

为了解决这个问题，2.8 开始就使用 psync 命令来代替 sync 命令去执行同步操作。

#### psync命令：

分为两种模式:

- 完整重同步：用于初次复制情况，执行过程同 sync。
- 部分重同步

**部分重同步**功能由以下 3 部分组成：

1. 主从服务器的复制偏移量 执行复制的主从服务器都会分别维护各自的复制偏移量：主服务器每次向从服务器传播 n 个字节数据时，都会将自己的复制偏移量加 n。从服务器接受主服务器传来的数据时，也会将自己的复制偏移量加 n, 当从服务器发现自己的偏移量和主服务器的不同，那么就会发送psyn命令寻求同步。
2. 运行id 从服务器会保存它的主服务器的id，如果断线重连发现保存的id和当前主服务器id不同，就会执行完成整同步。
3. 复制积压缓冲区 复制积压缓冲区是一个固定长度，先进先出的队列，默认 1MB。 当主服务器进行命令传播时，不仅会将命令发送给从服务器，还会发送给这个缓冲区，缓冲区中顺序保存着命令到偏移量的映射，当从服务器向主服务器发送 psync 命令时，也会发送自己的偏移量，主服务器通过这个复制偏移量和复制积压缓冲区的偏移量进行对比。若复制积压缓冲区存在从服务器的复制偏移量 + 1 后的数据，则进行部分重同步，否则进行完整重同步。